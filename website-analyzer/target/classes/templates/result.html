<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Analysis Result</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <h3 class="text-success mb-4">Website Analysis</h3>

    <div id="loading" class="alert alert-info text-center">‚è≥ Analyzing website... Please wait.</div>

    <table id="resultTable" class="table table-bordered d-none">
        <tr><th>Website URL</th><td th:text="${result.url}"></td></tr>
        <tr><th>Title</th><td id="title">Pending...</td></tr>
        <tr><th>Meta Description</th><td id="metaDescription">Pending...</td></tr>
        <tr><th>Word Count</th><td id="wordCount">Pending...</td></tr>
        <tr><th>SSL Valid</th><td id="sslValid">Pending...</td></tr>
        <tr><th>SSL Issuer</th><td id="sslIssuer">Pending...</td></tr>
        <tr><th>SSL Expiry</th><td id="sslExpiryDate">Pending...</td></tr>
        <tr><th>Domain Info</th><td id="domainInfo">Pending...</td></tr>
        <tr><th>Total Links</th><td id="totalLinks">Pending...</td></tr>
        <tr><th>Broken Links</th><td id="brokenLinks">Pending...</td></tr>
        <tr><th>Security Headers</th><td id="securityHeaders">Pending...</td></tr>
        <tr><th>Score</th><td id="score">Pending...</td></tr>
    </table>

    <div class="mt-3">
        <a href="/" class="btn btn-primary">Analyze Another</a>
        <a href="/history" class="btn btn-outline-secondary">View History</a>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var resultId = /*[[${result.id}]]*/ 0;

    function fetchResult() {
        $.get('/api/result/' + resultId, function(data) {
            if (!data) return;
            // show table always but replace values
            $('#loading').addClass('d-none');
            $('#resultTable').removeClass('d-none');

            $('#title').text(data.title || 'N/A');
            $('#metaDescription').text(data.metaDescription || 'N/A');
            $('#wordCount').text(data.wordCount || 0);
            $('#sslValid').text(data.sslValid ? 'Yes' : (data.sslValid === false ? 'No' : 'Pending'));
            $('#sslIssuer').text(data.sslIssuer || 'N/A');
            $('#sslExpiryDate').text(data.sslExpiryDate || 'N/A');
            $('#domainInfo').text(data.domainInfo || 'N/A');
            $('#totalLinks').text(data.totalLinks || 0);
            $('#brokenLinks').text(data.brokenLinks || 0);
            $('#securityHeaders').text(data.securityHeaders ? JSON.stringify(data.securityHeaders) : '{}');
            $('#score').text(data.score || 0);
        });
    }

    // Poll for updates; stop when score > 0 or after many attempts
    var attempts = 0;
    var poll = setInterval(function() {
        attempts++;
        fetchResult();
        if (attempts > 60) clearInterval(poll); // stop after ~2 minutes
    }, 2000);
    /*]]>*/
</script>
</body>
</html>
